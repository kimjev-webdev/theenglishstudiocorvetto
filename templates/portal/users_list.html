{% extends "base.html" %}
{% load portal_extras %}
{% block content %}
<div class="container py-4">

  <div class="row">
    <div class="col-12">
      <h2 class="mb-3">Users</h2>
    </div>
  </div>

  {# --- Mobile-first cards (only on xs) --- #}
  <div class="row d-sm-none">
    {% for u in users %}
    <div class="col-12">
      <div class="card mb-3 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="card-title mb-1">{{ u.username }}</h5>
            <span class="badge {{ u.is_active|yesno:'bg-success,bg-secondary' }}">
              {{ u.is_active|yesno:'Active,Inactive' }}
            </span>
          </div>

          <p class="mb-1"><strong>Name:</strong> {{ u.get_full_name|default:"—" }}</p>
          <p class="mb-1"><strong>Email:</strong> {{ u.email|default:"—" }}</p>
          <p class="mb-2"><strong>Staff:</strong> {{ u.is_staff|yesno:'Yes,No' }}</p>

          <div class="mb-3">
            {% for g in u.groups.all %}
              <span class="badge bg-secondary me-1 mb-1">{{ g.name }}</span>
            {% empty %}
              <span class="text-muted">No groups</span>
            {% endfor %}
          </div>

          <div class="d-flex gap-2 flex-wrap">
            <a href="{% url 'portal:portal_user_edit' u.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
            {% with ru=request.user.username|lower uu=u.username|lower isowner=u|is_owner %}
              {% if ru != uu and not isowner %}
                <form action="{% url 'portal:portal_user_delete' u.id %}" method="post" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger"
                          onclick="return confirm('Delete {{ u.username }}?')">
                    Delete
                  </button>
                </form>
              {% endif %}
            {% endwith %}
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="alert alert-info">No users found.</div>
    </div>
    {% endfor %}
  </div>

  {# --- Table for sm and up --- #}
  <div class="row d-none d-sm-block">
    <div class="col-12">
      <div class="table-responsive-sm">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Username</th>
              <th class="d-none d-md-table-cell">Name</th>
              <th class="d-none d-md-table-cell">Email</th>
              <th>Active</th>
              <th>Staff</th>
              <th class="d-none d-lg-table-cell">Groups</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          {% for u in users %}
            <tr>
              <td class="text-nowrap">{{ u.username }}</td>
              <td class="d-none d-md-table-cell">{{ u.get_full_name|default:"—" }}</td>
              <td class="d-none d-md-table-cell text-break">{{ u.email|default:"—" }}</td>
              <td>{{ u.is_active|yesno:"Yes,No" }}</td>
              <td>{{ u.is_staff|yesno:"Yes,No" }}</td>
              <td class="d-none d-lg-table-cell">
                {% for g in u.groups.all %}
                  <span class="badge bg-secondary me-1 mb-1">{{ g.name }}</span>
                {% empty %}—{% endfor %}
              </td>
              <td class="text-nowrap">
                <a href="{% url 'portal:portal_user_edit' u.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                {% with ru=request.user.username|lower uu=u.username|lower isowner=u|is_owner %}
                  {% if ru != uu and not isowner %}
                    <form action="{% url 'portal:portal_user_delete' u.id %}" method="post" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-danger"
                              onclick="return confirm('Delete {{ u.username }}?')">
                        Delete
                      </button>
                    </form>
                  {% endif %}
                {% endwith %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="7" class="text-center text-muted">No users found.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-12">
      <a href="{% url 'portal:portal_dashboard' %}" class="btn btn-red">GO BACK</a>
    </div>
  </div>

</div>
{% endblock %}
