{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Contact Us" %}{% endblock %}

{% block content %}
<div class="container px-3">
  <div class="row contact_row">
    <!-- Contact Form -->
    <section class="col-md-6">
      <h2 class="primaryfont red text-center mb-2">{% trans "Contact Us" %}</h2>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} mb-3" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}

      <form method="POST" action="{% url 'contact' %}" novalidate>
        {% csrf_token %}
        {% if form.non_field_errors %}
          <div class="alert alert-danger" role="alert">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        <div class="mb-3">
          <label for="fullName" class="form-label body-text navy">
            {% trans "Full Name" %}
            {% if form.full_name.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          <input
            type="text"
            class="form-control body-text navy {% if form.full_name.errors %}is-invalid{% endif %}"
            id="fullName"
            name="full_name"
            {% if form.full_name.field.required %}required{% endif %}
            value="{{ form.full_name.value|default_if_none:'' }}"
          >
          {% if form.full_name.errors %}
            <div class="invalid-feedback">{{ form.full_name.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label for="email" class="form-label body-text navy">
            {% trans "Email" %}
            {% if form.email.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          <input
            type="email"
            class="form-control body-text navy {% if form.email.errors %}is-invalid{% endif %}"
            id="email"
            name="email"
            {% if form.email.field.required %}required{% endif %}
            value="{{ form.email.value|default_if_none:'' }}"
          >
          {% if form.email.errors %}
            <div class="invalid-feedback">{{ form.email.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label for="phone" class="form-label body-text navy">
            {% trans "Phone" %} <span class="text-muted">({% trans "optional" %})</span>
          </label>
          <input
            type="tel"
            class="form-control body-text navy {% if form.phone.errors %}is-invalid{% endif %}"
            id="phone"
            name="phone"
            value="{{ form.phone.value|default_if_none:'' }}"
            aria-required="false"
          >
          {% if form.phone.errors %}
            <div class="invalid-feedback">{{ form.phone.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label for="subject" class="form-label body-text navy">
            {% trans "Subject" %}
            {% if form.subject.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          {% with current=form.subject.value|default_if_none:'' %}
          <select
            class="form-select body-text navy {% if form.subject.errors %}is-invalid{% endif %}"
            id="subject"
            name="subject"
            {% if form.subject.field.required %}required{% endif %}
          >
            <option value="">{% trans "Select an option" %}</option>
            <option value="After School Club" {% if current == "After School Club" %}selected{% endif %}>{% trans "After School Club" %}</option>
            <option value="Private Lessons" {% if current == "Private Lessons" %}selected{% endif %}>{% trans "Private Lessons" %}</option>
            <option value="Business English Lessons" {% if current == "Business English Lessons" %}selected{% endif %}>{% trans "Business English Lessons" %}</option>
            <option value="General English Lessons" {% if current == "General English Lessons" %}selected{% endif %}>{% trans "General English Lessons" %}</option>
            <option value="IELTS Enquiry" {% if current == "IELTS Enquiry" %}selected{% endif %}>{% trans "IELTS Enquiry" %}</option>
            <option value="Events" {% if current == "Events" %}selected{% endif %}>{% trans "Events" %}</option>
            <option value="Other" {% if current == "Other" %}selected{% endif %}>{% trans "Other" %}</option>
          </select>
          {% endwith %}
          {% if form.subject.errors %}
            <div class="invalid-feedback">{{ form.subject.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label for="message" class="form-label body-text navy">
            {% trans "Message" %}
            {% if form.message.field.required %}<span class="text-danger">*</span>{% endif %}
          </label>
          <textarea
            class="form-control body-text navy {% if form.message.errors %}is-invalid{% endif %}"
            id="message"
            name="message"
            rows="5"
            {% if form.message.field.required %}required{% endif %}
          >{{ form.message.value|default_if_none:'' }}</textarea>
          {% if form.message.errors %}
            <div class="invalid-feedback">{{ form.message.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="form-check mb-3">
          <input
            class="form-check-input btn-red"
            type="checkbox"
            id="subscribe"
            name="subscribe"
            {% if form.subscribe.value %}checked{% endif %}
          >
          <label class="form-check-label body-text navy" for="subscribe">
            {% trans "Subscribe to newsletter" %}
          </label>
        </div>

        <button type="submit" class="btn center-on-mobile primaryfont btn-red mb-3">
          {% trans "Send Message" %}
        </button>
      </form>
    </section>

    <!-- Right Column: Contact Info + Map -->
    <section class="col-md-6">
      <div class="contact-info">
        <h3 class="red primaryfont text-center contact_header">{% trans "Where to find us" %}</h3>
        <ul class="list-unstyled body-text navy lh-lg">
          <li>
            <i class="fas fa-map-marker-alt fa-lg red"></i>
            <strong>{% trans "Address" %}:</strong> Via Oglio, 3, Corvetto, Milano, 20139
          </li>
          <li>
            <i class="fas fa-phone-alt fa-lg red"></i>
            <strong>{% trans "Phone" %}:</strong> +39 389 182 8174
          </li>
          <li>
            <i class="fas fa-envelope fa-lg red"></i>
            <strong>{% trans "Email" %}:</strong> theenglishstudiocorvetto@gmail.com
          </li>
        </ul>
      </div>

      <!-- Google Map container -->
      <div
        id="map"
        class="map"
        style="height: 425px; width: 100%; border-radius: 8px;"
        data-lat="45.44110705149633"
        data-lng="9.220700957234282"
        data-pin-url="{% static 'compressed/map_pin.webp' %}">
      </div>
    </section>
  </div>

  <!-- Thank You Modal -->
  <div
    class="modal fade"
    id="thankYouModal"
    data-show="{% if show_modal %}true{% else %}false{% endif %}"
    tabindex="-1"
    aria-labelledby="thankYouLabel"
    aria-describedby="thankYouBody"
    aria-hidden="true"
    role="dialog"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <div class="modal-header border-0">
          <h5 class="modal-title primaryfont red w-100" id="thankYouLabel">
            {% trans "Thank you!" %}
          </h5>
        </div>
        <div class="modal-body body-text navy text-center" id="thankYouBody">
          <p>{% trans "We look forward to embarking on this exciting journey with you!" %}</p>
          <p>{% trans "We aim to reply within 1â€“2 working days." %}</p>
        </div>
        <button
          type="button"
          class="btn btn-red primaryfont modal-button"
          data-bs-dismiss="modal"
        >
          {% trans "Close" %}
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/maps.js' %}"></script>
  <script src="{% static 'js/contact.js' %}"></script>

  <!-- Official Google Maps async loader -->
  <script>
    (g => {
      var h, a, k, p = "The Google Maps JavaScript API",
          c = "google", l = "importLibrary", q = "__ib__", m = document, b = window;
      b = b[c] || (b[c] = {});
      var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams,
          u = () => h || (h = new Promise(async (f, n) => {
            await (a = m.createElement("script"));
            e.set("libraries", [...r] + "");
            for (k in g)
              e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
            e.set("callback", c + ".maps." + q);
            a.src = `https://maps.googleapis.com/maps/api/js?` + e;
            d[q] = f;
            a.onerror = () => h = n(Error(p + " could not load."));
            a.nonce = m.querySelector("script[nonce]")?.nonce || "";
            m.head.append(a);
          }));
      d[l] ? console.warn(p + " only loads once. Ignoring:", g)
           : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n));
    })({ key: "{{ GOOGLE_MAPS_API_KEY }}", v: "weekly" });
  </script>

  <!-- Bullet-proof modal trigger -->
  <script>
    (function () {
      function showThankYou() {
        var el = document.getElementById('thankYouModal');
        if (!el) return;
        var shouldShow = (el.getAttribute('data-show') || '')
                          .toLowerCase() === 'true';
        if (!shouldShow) return;
        if (window.bootstrap && window.bootstrap.Modal) {
          new bootstrap.Modal(el).show();
        }
      }
      window.addEventListener('load', showThankYou);
    }());
  </script>
{% endblock %}
